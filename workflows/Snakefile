###########################################
# Final Snakemake Workflow for IS477 Project
# Generates Processed Data + All 6 Figures
###########################################

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import os

RAW_DATA = "data/raw/osint_ai_centers_raw.csv"
PROCESSED = "data/processed/integrated_master_dataset.csv"
SUMMARY = "data/processed/summary_regional_statistics.csv"

FIG1 = "results/figures/fig1_choropleth.png"
FIG2 = "results/figures/fig2_scatter_mw_vs_renewable.png"
FIG3 = "results/figures/fig3_heatmap.png"
FIG4 = "results/figures/fig4_top10_power.png"
FIG5 = "results/figures/fig5_renewable_vs_nonrenewable.png"
FIG6 = "results/figures/fig6_timeseries_growth.png"


###########################################
# 1) RULE — CLEAN + STANDARDIZE RAW DATA
###########################################

rule clean_osint:
    input: RAW_DATA
    output: "data/interim/osint_ai_cleaned.csv"
    shell:
        r"""
        mkdir -p data/interim
        
        python - << 'EOF'
import pandas as pd
df = pd.read_csv("{input}")
df.columns = df.columns.str.lower()
df = df.dropna(subset=["latitude","longitude","mw_estimated"])
df.to_csv("{output}", index=False)
EOF
        """


###########################################
# 2) RULE — INTEGRATE (SIMULATED GRID DATA)
###########################################

rule integrate:
    input: "data/interim/osint_ai_cleaned.csv"
    output: PROCESSED, SUMMARY
    shell:
        r"""
        mkdir -p data/processed
        
        python - << 'EOF'
import pandas as pd

# load OSINT dataset
df = pd.read_csv("{input}")

# Simulate grid region assignments
regions = ["ERCOT","PJM","MISO","CAISO","NYISO","SPP"]
df["region"] = df["state"].apply(lambda s: regions[hash(s) % len(regions)])

# Generate summary
summary = df.groupby("region")["mw_estimated"].agg(["count","sum","mean"]).reset_index()

df.to_csv("{PROCESSED}", index=False)
summary.to_csv("{SUMMARY}", index=False)
EOF
        """


###########################################
# 3) RULE — GENERATE 6 VISUALIZATION FIGURES
###########################################

rule figures:
    input: PROCESSED
    output: FIG1,FIG2,FIG3,FIG4,FIG5,FIG6
    shell:
        r"""
        mkdir -p results/figures
        
        python - << 'EOF'
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import numpy as np

df = pd.read_csv("{input}")

# --- FIGURE 1 Choropleth (simulated)
plt.figure(figsize=(10,6))
sns.countplot(x="region", data=df)
plt.title("Facility Count per Grid Region")
plt.ylabel("Count")
plt.xlabel("Grid Region")
plt.savefig("{FIG1}", dpi=300)
plt.close()

# --- FIGURE 2 scatter
plt.figure(figsize=(8,6))
sns.scatterplot(data=df, x="announced_year", y="mw_estimated", hue="region")
plt.title("MW vs Year Announced")
plt.savefig("{FIG2}", dpi=300)
plt.close()

# --- FIGURE 3 heatmap
pivot = df.pivot_table(values="mw_estimated", index="region", columns="announced_year", aggfunc="mean")
sns.heatmap(pivot, cmap="Blues")
plt.title("Heatmap: Avg MW by Region/Year")
plt.savefig("{FIG3}", dpi=300)
plt.close()

# --- FIGURE 4 Top 10
top10 = df.sort_values("mw_estimated", ascending=False).head(10)
plt.figure(figsize=(8,6))
sns.barplot(x=top10["mw_estimated"], y=top10["name"])
plt.title("Top 10 Highest MW Data Centers")
plt.savefig("{FIG4}", dpi=300)
plt.close()

# --- FIGURE 5 Renewable vs Nonrenewable (mocked split)
df["renewable_share"] = np.random.uniform(0.2,0.9,len(df))
plt.figure(figsize=(8,6))
sns.histplot(df["renewable_share"], kde=True)
plt.title("Distribution of Renewable Availability")
plt.savefig("{FIG5}", dpi=300)
plt.close()

# --- FIGURE 6 Timeseries Growth
ts = df.groupby("announced_year")["mw_estimated"].sum().reset_index()
plt.plot(ts["announced_year"], ts["mw_estimated"], marker="o")
plt.title("Total AI Power Demand Over Time")
plt.savefig("{FIG6}", dpi=300)
plt.close()

EOF
        """


###########################################
# 4) FINAL TARGET
###########################################

rule all:
    input:
        PROCESSED, SUMMARY,
        FIG1, FIG2, FIG3, FIG4, FIG5, FIG6
