#############################################
# IS477 Final Project — Full Workflow
# Windows-Compatible Snakemake (NO bash)
#############################################

from pathlib import Path


# ======================
# File Structure
# ======================

RAW_DATA = "data/raw/osint_ai_centers_raw.csv"

CLEANED = "data/interim/osint_ai_cleaned.csv"

PROCESSED = "data/processed/integrated_master_dataset.csv"
SUMMARY   = "data/processed/summary_regional_statistics.csv"

FIG1 = "results/figures/fig1_choropleth.png"
FIG2 = "results/figures/fig2_scatter_mw_vs_renewable.png"
FIG3 = "results/figures/fig3_heatmap.png"
FIG4 = "results/figures/fig4_top10_power.png"
FIG5 = "results/figures/fig5_renewable_vs_nonrenewable.png"
FIG6 = "results/figures/fig6_timeseries_growth.png"


# ======================
# FINAL TARGETS
# ======================

rule all:
    input:
        CLEANED,
        PROCESSED,
        SUMMARY,
        FIG1, FIG2, FIG3, FIG4, FIG5, FIG6


# ======================
# 1) Clean Raw OSINT Data
# ======================

rule clean_osint:
    input: RAW_DATA
    output: CLEANED
    run:
        import pandas as pd
        Path("data/interim").mkdir(parents=True, exist_ok=True)
        df = pd.read_csv(input[0])
        df.columns = df.columns.str.lower()
        df = df.dropna(subset=["latitude", "longitude", "mw_estimated"])
        df.to_csv(output[0], index=False)


# ======================
# 2) Integrate — Generate Processed Data
# ======================

rule integrate:
    input: CLEANED
    output: PROCESSED, SUMMARY
    run:
        import pandas as pd
        Path("data/processed").mkdir(parents=True, exist_ok=True)

        df = pd.read_csv(input[0])

        # pseudo grid-region generation
        regions = ["ERCOT", "PJM", "MISO", "CAISO", "NYISO", "SPP"]
        df["region"] = df["state"].astype(str).apply(
            lambda x: regions[hash(x) % len(regions)]
        )

        summary = df.groupby("region")["mw_estimated"].agg(
            ["count","sum","mean"]).reset_index()

        df.to_csv(output[0], index=False)
        summary.to_csv(output[1], index=False)


# ======================
# 3) VISUALIZATIONS — Figures
# ======================

rule figures:
    input: PROCESSED
    output: FIG1, FIG2, FIG3, FIG4, FIG5, FIG6
    run:
        import os, warnings
        warnings.filterwarnings("ignore")
        os.environ["MPLBACKEND"] = "Agg"
        import matplotlib
        matplotlib.use("Agg")

        import pandas as pd
        import matplotlib.pyplot as plt
        import seaborn as sns
        import numpy as np

        df = pd.read_csv(input[0])
        Path("results/figures").mkdir(parents=True, exist_ok=True)

        # --- Fig1 ---
        plt.figure(figsize=(10,6))
        sns.countplot(x="region", data=df)
        plt.title("Facility Count per Grid Region")
        plt.savefig(output[0], dpi=300); plt.close()

        # --- Fig2 ---
        plt.figure(figsize=(8,6))
        sns.scatterplot(data=df, x="announced_year", y="mw_estimated", hue="region")
        plt.title("MW vs Year Announced")
        plt.savefig(output[1], dpi=300); plt.close()

        # --- Fig3 ---
        pivot = df.pivot_table(values="mw_estimated",
                               index="region",
                               columns="announced_year",
                               aggfunc="mean")
        plt.figure(figsize=(8,6))
        sns.heatmap(pivot, cmap="Blues")
        plt.title("MW Heatmap by Region/Year")
        plt.savefig(output[2], dpi=300); plt.close()

        # --- Fig4 ---
        top10 = df.sort_values("mw_estimated",ascending=False).head(10)
        plt.figure(figsize=(8,6))
        sns.barplot(x="mw_estimated",y="name",data=top10)
        plt.title("Top10 Compute Facilities")
        plt.savefig(output[3], dpi=300); plt.close()

        # --- Fig5 ---
        np.random.seed(42)
        df["renewable_share"]=np.random.uniform(0.2,0.9,len(df))
        plt.figure(figsize=(8,6))
        sns.histplot(df["renewable_share"],kde=True)
        plt.title("Renewable Availability Distribution")
        plt.savefig(output[4], dpi=300); plt.close()

        # --- Fig6 ---
        ts = df.groupby("announced_year")["mw_estimated"].sum().reset_index()
        plt.figure(figsize=(8,6))
        plt.plot(ts["announced_year"],ts["mw_estimated"],marker="o")
        plt.title("Growth of Estimated AI Power Use")
        plt.savefig(output[5], dpi=300); plt.close()
