rule figures:
    input:
        PROCESSED
    output:
        FIG1, FIG2, FIG3, FIG4, FIG5, FIG6
    run:
        import os
        import warnings

        # 彻底关掉 matplotlib 的 warning，避免 warn_external 里用到奇怪的正则配置
        warnings.filterwarnings("ignore")

        # 强制使用非 GUI 后端
        os.environ["MPLBACKEND"] = "Agg"
        import matplotlib
        matplotlib.use("Agg")

        import pandas as pd
        import matplotlib.pyplot as plt
        import seaborn as sns
        import numpy as np
        from pathlib import Path

        df = pd.read_csv(input[0])

        out_paths = [Path(p) for p in output]
        for p in out_paths:
            p.parent.mkdir(parents=True, exist_ok=True)

        # FIGURE 1: Count per region
        plt.figure(figsize=(10, 6))
        sns.countplot(x="region", data=df)
        plt.title("Facility Count per Grid Region")
        plt.ylabel("Count")
        plt.xlabel("Grid Region")
        plt.tight_layout()
        plt.savefig(output[0], dpi=300)
        plt.close()

        # FIGURE 2: MW vs year
        plt.figure(figsize=(8, 6))
        sns.scatterplot(data=df, x="announced_year", y="mw_estimated", hue="region")
        plt.title("MW vs Year Announced")
        plt.tight_layout()
        plt.savefig(output[1], dpi=300)
        plt.close()

        # FIGURE 3: heatmap
        pivot = df.pivot_table(
            values="mw_estimated",
            index="region",
            columns="announced_year",
            aggfunc="mean",
        )
        plt.figure(figsize=(8, 6))
        sns.heatmap(pivot, cmap="Blues", annot=False)
        plt.title("Heatmap: Avg MW by Region and Year")
        plt.tight_layout()
        plt.savefig(output[2], dpi=300)
        plt.close()

        # FIGURE 4: top 10
        top10 = df.sort_values("mw_estimated", ascending=False).head(10)
        plt.figure(figsize=(8, 6))
        sns.barplot(x="mw_estimated", y="name", data=top10)
        plt.title("Top 10 Highest MW Data Centers")
        plt.xlabel("Estimated MW")
        plt.ylabel("Facility")
        plt.tight_layout()
        plt.savefig(output[3], dpi=300)
        plt.close()

        # FIGURE 5: renewable share (simulated)
        np.random.seed(42)
        df["renewable_share"] = np.random.uniform(0.2, 0.9, len(df))
        plt.figure(figsize=(8, 6))
        sns.histplot(df["renewable_share"], kde=True)
        plt.title("Distribution of Renewable Availability (Simulated)")
        plt.xlabel("Renewable Share")
        plt.tight_layout()
        plt.savefig(output[4], dpi=300)
        plt.close()

        # FIGURE 6: time series
        ts = df.groupby("announced_year")["mw_estimated"].sum().reset_index()
        plt.figure(figsize=(8, 6))
        plt.plot(ts["announced_year"], ts["mw_estimated"], marker="o")
        plt.title("Total AI Power Demand Over Time")
        plt.xlabel("Year Announced")
        plt.ylabel("Total Estimated MW")
        plt.tight_layout()
        plt.savefig(output[5], dpi=300)
        plt.close()
